# Manual Bootstrap Tests

This directory contains interactive demo applications for testing the `SessionManager` bootstrap service manually with real libp2p nodes.

## Overview

The manual tests consist of two complementary programs that demonstrate the bootstrap handshake flow:

- **`bootstrap-listen.ts`** - The Initiator (Party A) that waits for connections
- **`bootstrap-dial.ts`** - The Respondent (Party B) that connects using a link

## Quick Start

### 1. Start the Listener (Party A)
```bash
npx tsx test/manual/bootstrap-listen.ts --role stock
```

This will:
- Start a libp2p node
- Create a SessionManager with demo hooks
- Register the bootstrap protocol handler
- Generate a link file (`/tmp/tally-link.json`)
- Print a ready-to-copy command for the responder

### 2. Run the Dialer (Party B)
Copy and paste the command printed by the listener, or manually run:
```bash
npx tsx test/manual/bootstrap-dial.ts /tmp/tally-link.json
```

This will:
- Read the link file
- Create a SessionManager for the dialer role
- Connect to the listener using the new bootstrap protocol
- Complete the bootstrap handshake
- Print the provisioning result

## Command Line Options

### bootstrap-listen.ts
```bash
npx tsx test/manual/bootstrap-listen.ts [options]
```

**Options:**
- `--role <stock|foil>` - Initiator role (default: `stock`)
  - `stock`: A provisions the database after approval
  - `foil`: B provisions the database and reports back to A
- `--token <string>` - Authentication token (default: `demo-abc`)
- `--ttl <milliseconds>` - Token expiry time in ms (default: `600000` = 10 minutes)
- `--out <path>` - Link file output path (default: `/tmp/tally-link.json`)

**Examples:**
```bash
# Default stock role
npx tsx test/manual/bootstrap-listen.ts

# Foil role with custom token
npx tsx test/manual/bootstrap-listen.ts --role foil --token my-custom-token

# Custom expiry and output location
npx tsx test/manual/bootstrap-listen.ts --ttl 300000 --out ./my-link.json
```

### bootstrap-dial.ts
```bash
npx tsx test/manual/bootstrap-dial.ts <link-file> [options]
```

**Arguments:**
- `<link-file>` - Path to the JSON link file generated by the listener

**Options:**
- `--identity <string>` - Identity information to send (default: `undefined`)

**Examples:**
```bash
# Basic usage
npx tsx test/manual/bootstrap-dial.ts /tmp/tally-link.json

# With custom identity
npx tsx test/manual/bootstrap-dial.ts /tmp/tally-link.json --identity "user@example.com"
```

## Understanding the Roles

### Stock Role (A=stock)
- **Listener**: A waits for B to connect
- **Handshake**: B presents token and identity to A
- **Provisioning**: A provisions the database and returns access info
- **Result**: A provides the database connection details to B

### Foil Role (A=foil)  
- **Listener**: A waits for B to connect
- **Handshake**: B presents token and identity to A
- **Provisioning**: B provisions the database after A approves
- **Result**: B sends database connection details back to A

## Example Session

### Terminal 1 (Listener)
```bash
$ npx tsx test/manual/bootstrap-listen.ts --role stock
Starting libp2p node...
Node started: 12D3KooWExample...
Addresses: ["/ip4/127.0.0.1/tcp/59123/p2p/12D3KooWExample..."]

Link written to: /tmp/tally-link.json

To test, run in another terminal:
npx tsx test/manual/bootstrap-dial.ts /tmp/tally-link.json

Waiting for connections... (Press Ctrl+C to stop)
```

### Terminal 2 (Dialer)
```bash
$ npx tsx test/manual/bootstrap-dial.ts /tmp/tally-link.json
Starting libp2p node...
Node started: 12D3KooWAnother...
Reading link from: /tmp/tally-link.json
Connecting to: /ip4/127.0.0.1/tcp/59123/p2p/12D3KooWExample...

✅ Bootstrap successful!
Result: {
  "tally": {
    "tallyId": "demo-tally-123",
    "createdBy": "stock"
  },
  "dbConnectionInfo": {
    "endpoint": "fake://database.example",
    "credentialsRef": "fake-credentials-456"
  }
}
```

### Terminal 1 (Listener - shows activity)
```bash
[A] Incoming bootstrap request...
[A] validateToken: demo-abc (session: session-123...)
[A] validateIdentity: undefined (session: session-123...)
[A] provisionDatabase by stock: 12D3... ↔ 12D3... (session: session-123...)
[A] provisioning complete: { tally: {...}, dbConnectionInfo: {...} }
[A] Bootstrap session completed
```

## Troubleshooting

### Connection Issues
- Ensure both programs use the same network interface (both default to 127.0.0.1)
- Check that the listener is running before starting the dialer
- Verify the link file path is correct

### Token/Identity Issues
- The demo uses SessionHooks that accept any valid token/identity
- For custom validation, modify the SessionHooks implementations in the source files

### Network Ports
- libp2p will choose random available ports
- Port conflicts are automatically resolved
- No manual port configuration needed

## What This Tests

These manual tests demonstrate:
- **Real libp2p networking** (not mocked)
- **Complete bootstrap flow** (Method 6: Role-Based Link Handshake)
- **SessionManager state machine architecture** (production implementation)
- **Both role variations** (stock and foil)
- **Error handling** (invalid tokens, connection failures)
- **Stream management** (proper libp2p stream lifecycle)
- **SessionHooks integration** (consumer-provided validation and provisioning)
- **Session isolation** (concurrent session support)

## Integration with Automated Tests

The automated tests (`test/auto/`) exercise the same functionality programmatically with multiple scenarios. The manual tests are useful for:
- Interactive debugging
- Visual confirmation of flows
- Performance testing with real network conditions
- Integration testing with external systems
